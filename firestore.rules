rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions for Data Validation ---
    function isString(val) { return val is string; }
    function isNumber(val) { return val is number; }
    function isList(val) { return val is list; }

    function isUserProfile(data) {
      return isString(data.id)
        && isString(data.firstName)
        && isString(data.lastName)
        && isString(data.email)
        && isString(data.role) && (data.role == 'Administration' || data.role == 'Sales' || data.role == 'Super Administration')
        // allow createdAt to be a string or a timestamp (serverTimestamp)
        && (isString(data.createdAt) || data.createdAt is timestamp)
        && (data.password == null || isString(data.password))
        && (data.pin == null || (isString(data.pin) && (data.pin.length() == 0 || data.pin.matches('^[0-9]{6}$'))));
    }

    function isProduct(data) {
      return isString(data.name)
        && isString(data.category)
        && isNumber(data.price)
        && isNumber(data.stock)
        && isNumber(data.lowStockThreshold)
        && isString(data.description);
    }

    function isSale(data) {
      return (isString(data.date) || data.date is timestamp)
        && isNumber(data.total)
        && isString(data.userId)
        && isString(data.salesperson)
        && isString(data.status)
        && (data.items == null || isList(data.items))
        && (data.paymentMethod == null || isString(data.paymentMethod))
        && (data.subtotal == null || isNumber(data.subtotal))
        && (data.tax == null || isNumber(data.tax))
        && (data.amountPaid == null || isNumber(data.amountPaid))
        && (data.change == null || isNumber(data.change))
        && (data.transactionType == null || isString(data.transactionType))
        && (data.withdrawalReason == null || isString(data.withdrawalReason))
        && (data.cardTransactionId == null || isString(data.cardTransactionId));
    }
    
    function isAuthorizedUpdate(data) {
        return data.authorizations is list && data.authorizations.size() > 0;
    }

    function isNewTillSession(data) {
       return (isString(data.startDate) || data.startDate is timestamp)
        && isNumber(data.openingBalance)
        && data.status == 'Active'
        && isString(data.userId)
        && isString(data.userName);
    }

    function isClosingTillSession(data) {
       return data.status == 'Closed'
      && (isString(data.endDate) || data.endDate is timestamp)
        && isNumber(data.expectedCash)
        && isNumber(data.countedCash)
        && isNumber(data.difference);
    }


    // --- Default Rule: Deny all access unless explicitly allowed ---
    match /{path=**} {
      allow read, write: if false;
    }

    // --- Users Collection ---
    // Allow creation with basic validation, updates with flexible fields, deletion allowed
    match /users/{userId} {
      allow read, list: if true; 
      allow create: if isString(request.resource.data.id)
        && isString(request.resource.data.firstName)
        && isString(request.resource.data.lastName)
        && isString(request.resource.data.email)
        && isString(request.resource.data.role)
        && (request.resource.data.role == 'Administration' || request.resource.data.role == 'Sales' || request.resource.data.role == 'Super Administration')
        && isString(request.resource.data.createdAt);
      allow update: if request.resource.data.keys().size() > 0
        && (request.resource.data.firstName == null || isString(request.resource.data.firstName))
        && (request.resource.data.lastName == null || isString(request.resource.data.lastName))
        && (request.resource.data.role == null || (isString(request.resource.data.role) && (request.resource.data.role == 'Administration' || request.resource.data.role == 'Sales' || request.resource.data.role == 'Super Administration')))
        && (request.resource.data.pin == null || (isString(request.resource.data.pin) && (request.resource.data.pin.length() == 0 || request.resource.data.pin.matches('^[0-9]{6}$'))));
      allow delete: if true;
    }

    // --- Products Collection ---
    // All signed-in users can read products. Writes and deletes are validated.
    match /products/{productId} {
      allow read, list: if true;
      allow write: if isProduct(request.resource.data);
      allow delete: if true;
    }

    // --- Categories Collection ---
    // All signed-in users can read categories. Writes and deletes are validated.
    match /categories/{categoryId} {
       allow read, list: if true;
       allow write: if isString(request.resource.data.name);
       allow delete: if true;
    }

    // --- Sales Collection ---
    // All users can read sales. Creates are validated. Updates allow partial updates. Deletes are blocked for audit trail.
    match /sales/{saleId} {
      allow read, list: if true;
      allow create: if isSale(request.resource.data);
      allow update: if isSale(request.resource.data);
      allow delete: if false;
    }

    // --- Till Sessions Collection ---
    // All users can read sessions. Creates/updates are validated. Deletes are blocked for audit trail.
    match /tillSessions/{sessionId} {
      allow read, list: if true;
      allow create: if isNewTillSession(request.resource.data);
      allow update: if request.resource.data.status == 'Closed' 
        && isString(request.resource.data.endDate)
        && isNumber(request.resource.data.expectedCash)
        && isNumber(request.resource.data.countedCash)
        && isNumber(request.resource.data.difference);
      allow delete: if false;
    }
  }
}

    