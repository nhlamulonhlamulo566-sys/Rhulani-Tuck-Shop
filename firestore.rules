rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions for Data Validation ---
    function isString(val) { return val is string; }
    function isNumber(val) { return val is number; }
    function isList(val) { return val is list; }

    function isUserProfile(data) {
      return isString(data.id)
        && isString(data.firstName)
        && isString(data.lastName)
        && isString(data.email)
        && isString(data.role) && (data.role == 'Administration' || data.role == 'Sales' || data.role == 'Super Administration')
        && isString(data.createdAt)
        && (data.pin == null || (isString(data.pin) && data.pin.matches('^[0-9]{6}$')));
    }

    function isProduct(data) {
      return isString(data.name)
        && isString(data.category)
        && isNumber(data.price)
        && isNumber(data.stock)
        && isNumber(data.lowStockThreshold)
        && isString(data.description);
    }

    function isSale(data) {
      return isString(data.date)
        && isNumber(data.total)
        && isString(data.userId)
        && isList(data.items)
        && isString(data.paymentMethod)
        && isNumber(data.subtotal)
        && isNumber(data.tax)
        && isNumber(data.amountPaid)
        && isNumber(data.change)
        && isString(data.salesperson)
        && isString(data.status);
    }
    
    function isAuthorizedUpdate(data) {
        return data.authorizations is list && data.authorizations.size() > 0;
    }

    function isNewTillSession(data) {
       return isString(data.startDate)
        && isNumber(data.openingBalance)
        && data.status == 'Active'
        && isString(data.userId)
        && isString(data.userName);
    }

    function isClosingTillSession(data) {
       return data.status == 'Closed'
        && isString(data.endDate)
        && isNumber(data.expectedCash)
        && isNumber(data.countedCash)
        && isNumber(data.difference);
    }


    // --- Default Rule: Deny all access unless explicitly allowed ---
    match /{path=**} {
      allow read, write: if false;
    }

    // --- Users Collection ---
    // INSECURE WARNING: Anyone can read or write to any user profile because we
    // cannot securely verify if a user is an administrator without Firebase Authentication.
    match /users/{userId} {
      allow read, list: if true; 
      allow write: if isUserProfile(request.resource.data);
    }

    // --- Products Collection ---
    // All signed-in users can read products. Writes are validated.
    match /products/{productId} {
      allow read, list: if true;
      allow write: if isProduct(request.resource.data);
    }

    // --- Categories Collection ---
    // All signed-in users can read categories.
    match /categories/{categoryId} {
       allow read, list: if true;
       allow write: if isString(request.resource.data.name); // Basic validation
    }

    // --- Sales Collection ---
    // All users can read sales. Creates are validated. Updates require authorization. Deletes are blocked.
    match /sales/{saleId} {
      allow read, list: if true;
      allow create: if isSale(request.resource.data);
      allow update: if isSale(request.resource.data) && isAuthorizedUpdate(request.resource.data);
      allow delete: if false;
    }

    // --- Till Sessions Collection ---
    // All users can read sessions. Creates/updates are validated. Deletes are blocked.
    match /tillSessions/{sessionId} {
      allow read, list: if true;
      allow create: if isNewTillSession(request.resource.data);
      allow update: if request.resource.data.status == 'Closed' 
        && isString(request.resource.data.endDate)
        && isNumber(request.resource.data.expectedCash)
        && isNumber(request.resource.data.countedCash)
        && isNumber(request.resource.data.difference);
      allow delete: if false;
    }
  }
}

    